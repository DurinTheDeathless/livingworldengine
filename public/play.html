<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Living World Engine â€“ Minimal Save Demo</title>
  <!-- Optional: Unifraktur font -->
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #2b1f13;
      color: #f4e3c1;
      font-family: Georgia, serif;
      margin: 0;
      padding: 20px;
    }
    .section {
      max-width: 800px;
      margin: 0 auto 20px auto;
      background-color: #3a2d1e;
      padding: 10px;
      border: 1px solid #c7b58d;
      border-radius: 5px;
    }
    h1 {
      font-family: 'UnifrakturCook', cursive;
      color: #ffd700;
      text-align: center;
      margin-bottom: 0.2em;
    }
    .divider {
      border: none;
      border-top: 1px solid #c7b58d;
      margin: 10px 0;
    }
    button {
      margin-right: 5px;
      background-color: #5c3e1a;
      color: #f4e3c1;
      border: 1px solid #7a5c3e;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      padding: 8px 12px;
    }
    button:hover {
      background-color: #8a5f2e;
    }
  </style>
</head>
<body>

<div class="section" style="text-align:center;">
  <h1>Living World Engine</h1>
  <div>
    <button id="saveDriveBtn">Save to Drive</button>
    <button id="saveFileBtn">Save to File</button>
  </div>
  <hr class="divider" />
</div>

<div id="info" class="section" style="text-align:center;">
  <h2 id="world-name">[World Name]</h2>
  <p>Created: <span id="created-on">[Loading...]</span></p>
  <p>Days Since Start: <span id="days-elapsed">[Loading...]</span></p>
</div>

<div id="overview" class="section">
  <h2>Overview</h2>
  <p contenteditable="true" id="world-summary" style="font-style: italic;">
    Click to add summary...
  </p>
</div>

<script>
  // Minimal data container
  let currentWorld = {};
  let currentFileName = null;  // The original file name from Drive or local
  let isDirty = false;

  // 1) Try to load from window.name
  if (window.name) {
    try {
      const payload = JSON.parse(window.name);
      if (payload.world) {
        currentWorld = payload.world;
        currentFileName = payload.fileName || null;
      }
    } catch (err) {
      console.warn("Could not parse window.name data:", err);
    }
    window.name = ""; // clear to avoid reuse
  }

  // 2) If not loaded from window.name, try local storage (optional)
  if (!currentWorld.name) {
    try {
      const stored = JSON.parse(localStorage.getItem("currentWorld") || "{}");
      if (stored.name) {
        currentWorld = stored;
        currentFileName = localStorage.getItem("worldFilename") || null;
      }
    } catch (e) {
      console.warn("No local storage data found.");
    }
  }

  // If we still have nothing, create a default skeleton
  if (!currentWorld.name) {
    currentWorld = {
      name: "Unnamed World",
      created: new Date().toISOString(),
      summary: "A brand new realm..."
    };
    currentFileName = "unnamed_world.json";
  }

  // HELPER: format date
  function formatDate(iso) {
    if (!iso) return "[Unknown]";
    const d = new Date(iso);
    if (isNaN(d)) return "[Unknown]";
    return d.toDateString(); // or a fancier approach
  }
  // HELPER: compute days since
  function daysSince(iso) {
    if (!iso) return "?";
    const d = new Date(iso);
    const now = new Date();
    const diff = now - d;
    return Math.floor(diff / (1000*60*60*24));
  }

  // Populate UI
  document.getElementById("world-name").textContent = currentWorld.name || "Unnamed World";
  document.getElementById("created-on").textContent = currentWorld.created ? formatDate(currentWorld.created) : "[None]";
  const ds = currentWorld.created ? daysSince(currentWorld.created) : "?";
  document.getElementById("days-elapsed").textContent = ds;
  document.getElementById("world-summary").textContent = currentWorld.summary || "";

  // Mark data dirty whenever user changes the summary
  const summaryElem = document.getElementById("world-summary");
  summaryElem.addEventListener("input", () => {
    currentWorld.summary = summaryElem.textContent;
    isDirty = true;
  });

  // 3) Save to Drive function
  async function saveToDrive() {
    // Must have an access token from sessionStorage
    const userStr = sessionStorage.getItem("user");
    if (!userStr) {
      alert("Not logged in. Cannot save to Drive.");
      return;
    }
    const token = JSON.parse(userStr).accessToken;
    if (!token) {
      alert("No token found. Log in first.");
      return;
    }
    if (!currentFileName) {
      // If we never had an original name, pick one
      currentFileName = currentWorld.name.replace(/\s+/g, "_") + ".json";
    }

    try {
      const res = await fetch("/drive/save", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          fileName: currentFileName,
          fileContent: currentWorld,
          accessToken: token
        })
      });
      const data = await res.json();
      if (!data.success) {
        alert("Failed to save to Drive.");
        console.error(data);
      } else {
        alert("World saved to Google Drive!");
        isDirty = false;
      }
    } catch (e) {
      console.error(e);
      alert("Error saving to Drive.");
    }
  }

  // 4) Save to File function
  function saveToFile() {
    let file = currentFileName || (currentWorld.name.replace(/\s+/g, "_") + ".json");
    const blob = new Blob([JSON.stringify(currentWorld, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = file;
    a.click();
    URL.revokeObjectURL(a.href);
    isDirty = false;
    alert("World saved to local file.");
  }

  // Attach button handlers
  document.getElementById("saveDriveBtn").addEventListener("click", saveToDrive);
  document.getElementById("saveFileBtn").addEventListener("click", saveToFile);

  // 5) Mark dirty on unload if needed
  window.addEventListener("beforeunload", (e) => {
    if (isDirty) {
      // Optionally warn user or do something else
      // e.returnValue = "You have unsaved changes. Sure to leave?";
    }
  });
</script>
</body>
</html>
